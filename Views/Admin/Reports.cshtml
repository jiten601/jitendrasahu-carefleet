@{
    ViewData["Title"] = "Reports & Analytics";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewBag.ActivePage = "Reports";
    ViewBag.HideHeader = true;

    // Data from ViewBag (populated in AdminController.Reports)
    var confirmed = ViewBag.AppointmentsConfirmed ?? 0;
    var pending = ViewBag.AppointmentsPending ?? 0;
    var cancelled = ViewBag.AppointmentsCancelled ?? 0;

    var months = Json.Serialize(ViewBag.Months);
    var patientGrowth = Json.Serialize(ViewBag.PatientGrowth);
    var doctorGrowth = Json.Serialize(ViewBag.DoctorGrowth);
}

<div class="fade-in">
    <!-- Premium Header Card -->
    <div class="premium-header-card animate-in">
        <div class="header-card-content">
            <div class="header-info">
                <h1 class="fw-bold text-white mb-2">Reports & Analytics</h1>
                <p class="text-white-50 mb-0">Monitor system growth and appointment distribution trends.</p>
            </div>
            <div class="header-actions">
                <button onclick="exportToCSV()" class="btn-premium-light">
                    <i class="fas fa-download me-2"></i>Export Dataset
                </button>
            </div>
        </div>
        <div class="header-bg-pattern"></div>
    </div>

    <!-- Analytics Summary -->
    <div class="summary-cards-premium">
        <div class="stat-card-premium stat-blue animate-in delay-1">
            <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
            <div class="stat-info">
                <span class="stat-label">Confirmation Rate</span>
                <span class="stat-value">@((confirmed + pending + cancelled) > 0 ? (confirmed * 100 / (confirmed + pending + cancelled)) : 0)%</span>
            </div>
        </div>
        <div class="stat-card-premium stat-emerald animate-in delay-2">
            <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
            <div class="stat-info">
                <span class="stat-label">Monthly Growth</span>
                <span class="stat-value">+@(ViewBag.PatientGrowth != null ? ((List<int>)ViewBag.PatientGrowth).Last() : 0)</span>
            </div>
        </div>
        <div class="stat-card-premium stat-amber animate-in delay-3">
            <div class="stat-icon"><i class="fas fa-clock"></i></div>
            <div class="stat-info">
                <span class="stat-label">Avg. Wait Time</span>
                <span class="stat-value">12m</span>
            </div>
        </div>
    </div>

    <div class="dashboard-grid animate-in delay-4">
        <!-- Line Chart: Growth -->
        <div class="activity-card">
            <div class="card-header-flex">
                <h3>User Registration Trend</h3>
                <span class="badge badge-info">Last 6 Months</span>
            </div>
            <div class="chart-container" style="position: relative; height:300px;">
                <canvas id="growthChart"></canvas>
            </div>
        </div>

        <!-- Doughnut Chart: Appointments -->
        <div class="activity-card">
            <div class="card-header-flex">
                <h3>Appointment status</h3>
            </div>
            <div class="chart-container" style="position: relative; height:300px;">
                <canvas id="appointmentChart"></canvas>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Growth Chart
            const ctxGrowth = document.getElementById('growthChart').getContext('2d');
            new Chart(ctxGrowth, {
                type: 'line',
                data: {
                    labels: @Html.Raw(months),
                    datasets: [{
                        label: 'Patients',
                        data: @Html.Raw(patientGrowth),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Doctors',
                        data: @Html.Raw(doctorGrowth),
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { display: false } },
                        x: { grid: { display: false } }
                    }
                }
            });

            // Appointment Chart
            const ctxApp = document.getElementById('appointmentChart').getContext('2d');
            new Chart(ctxApp, {
                type: 'doughnut',
                data: {
                    labels: ['Confirmed', 'Pending', 'Cancelled'],
                    datasets: [{
                        data: [@confirmed, @pending, @cancelled],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    },
                    cutout: '70%'
                }
            });
        });

        function exportToCSV() {
            const data = [
                ['Metric', 'Value'],
                ['Confirmed Appointments', '@confirmed'],
                ['Pending Appointments', '@pending'],
                ['Cancelled Appointments', '@cancelled'],
                ['Total Growth (Recent)', '@(ViewBag.PatientGrowth != null ? ((List<int>)ViewBag.PatientGrowth).Last() : 0)']
            ];
            
            let csvContent = "data:text/csv;charset=utf-8,";
            data.forEach(row => {
                csvContent += row.join(",") + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "carefleet_report.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
}
