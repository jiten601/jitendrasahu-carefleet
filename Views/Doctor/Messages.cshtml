@{
    ViewData["Title"] = "Messages";
    Layout = "~/Views/Shared/_DoctorLayout.cshtml";
    ViewBag.ActivePage = "Messages";
    ViewBag.HideHeader = true;
}

@section Styles {
    <link rel="stylesheet" href="~/css/messaging.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/video-call.css" asp-append-version="true" />
}


<!-- Header Card -->
<div class="messages-page-wrapper doctor-theme fade-in">
    <div class="premium-header-card mb-4">
        <div class="header-card-content">
            <div class="header-info">
                <h1 class="fw-bold text-white mb-2">Secure Messaging</h1>
                <p class="text-white opacity-75 mb-0">Communicate securely with your patients.</p>
            </div>
            <div class="header-actions">
                <button class="btn-premium-light" onclick="alert('Broadcasting feature is being optimized...')">
                    <i class="fas fa-plus me-2"></i>New Conversation
                </button>
            </div>
        </div>
        <div class="header-bg-pattern"></div>
    </div>

    <div class="dashboard-card messages-main-card">
        <div class="messages-split-layout">
            <!-- Sidebar: Conversations List -->
            <aside class="conversations-sidebar">
                <div class="sidebar-header-internal">
                    <h5 class="sidebar-title fw-bold">Conversations</h5>
                    <div class="search-box-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="patientSearch" class="search-input" placeholder="Search patients...">
                    </div>
                </div>
                
                <div class="conversations-list custom-scrollbar" id="conversationsList">
                    @if (ViewBag.Contacts != null && ((IEnumerable<CareFleet.Models.Patient>)ViewBag.Contacts).Any())
                    {
                        foreach (var contact in (IEnumerable<CareFleet.Models.Patient>)ViewBag.Contacts)
                        {
                            bool isActive = ViewBag.SelectedContactEmail == contact.Email;
                            <div class="conversation-item @(isActive ? "active" : "")" 
                                 onclick="location.href='@Url.Action("Messages", "Doctor", new { receiverEmail = contact.Email })'"
                                 data-name="@contact.FirstName.ToLower() @contact.LastName.ToLower()">
                                <div class="position-relative">
                                    <div class="user-avatar-medium bg-light text-primary">
                                        <span>@(contact.FirstName[0])@(contact.LastName[0])</span>
                                    </div>
                                    <span class="status-indicator online"></span>
                                </div>
                                <div class="conversation-details">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="contact-name mb-0">@contact.FirstName @contact.LastName</h6>
                                        <span class="time-stamp">@contact.Gender</span>
                                    </div>
                                    <p class="last-message text-truncate mb-0">Tap to start chatting</p>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="p-4 text-center text-muted">
                            <i class="fas fa-user-friends fa-2x mb-3 opacity-10"></i>
                            <p class="small mb-0">No conversations found.</p>
                        </div>
                    }
                </div>
                
                <!-- Active Indicator Bar at bottom (matching image) -->
                <div class="p-2 bg-light bg-opacity-50">
                    <div class="progress" style="height: 8px; border-radius: 4px; background: #cbd5e1;">
                        <div class="progress-bar" style="width: 30%; background: #94a3b8;"></div>
                    </div>
                </div>
            </aside>

            <!-- Main: Chat Window -->
            <section class="chat-window">
                <header class="chat-window-header">
                    <div class="d-flex align-items-center">
                        <div class="user-avatar-medium bg-light text-primary me-3">
                            @if (ViewBag.SelectedContactName != null)
                            {
                                <span>@(ViewBag.SelectedContactName.Substring(0, 1))</span>
                            }
                            else
                            {
                                <i class="fas fa-user"></i>
                            }
                        </div>
                        <div>
                            <h6 class="fw-800 mb-0">@ViewBag.SelectedContactName</h6>
                            <div class="status-label d-flex align-items-center">
                                <span class="status-dot-mini"></span>
                                <span>Patient</span>
                            </div>
                        </div>
                    </div>
                    <div class="header-tools d-flex gap-2">

                        <button class="btn-tool" onclick="startVideoCall('@ViewBag.SelectedContactName', '@(ViewBag.SelectedContactName != null ? ViewBag.SelectedContactName.Substring(0, 1) : "P")')" title="Video Call">
                            <i class="fas fa-video"></i>
                        </button>
                        <button class="btn-tool" onclick="location.href='@Url.Action("Patients", "Doctor")'" title="Patient Info">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </div>
                </header>

                <div class="chat-history-container custom-scrollbar" id="chatHistory">
                    @if (ViewBag.ChatHistory != null && ((IEnumerable<CareFleet.Models.Message>)ViewBag.ChatHistory).Any())
                    {
                        foreach (var msg in (IEnumerable<CareFleet.Models.Message>)ViewBag.ChatHistory)
                        {
                            bool isOutgoing = msg.SenderEmail == Context.Session.GetString("UserEmail");
                            <div class="message-group">
                                <div class="message-item @(isOutgoing ? "outgoing" : "incoming")">
                                    <div class="message-bubble shadow-sm">
                                        @if (!string.IsNullOrEmpty(msg.Content))
                                        {
                                            <div class="message-text">@msg.Content</div>
                                        }
                                        @if (!string.IsNullOrEmpty(msg.AttachmentPath))
                                        {
                                            <div class="message-attachment mt-2">
                                                <a href="@msg.AttachmentPath" target="_blank" class="attachment-link">
                                                    <i class="fas fa-file-download me-2"></i>
                                                    @msg.AttachmentName
                                                </a>
                                            </div>
                                        }
                                    </div>
                                    <div class="message-time">
                                        @msg.Timestamp.ToString("hh:mm tt")
                                        @if (isOutgoing) { 
                                            <i class="fas fa-check-double ms-1 @(msg.IsRead ? "text-primary" : "")"></i> 
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else if (string.IsNullOrEmpty(ViewBag.SelectedContactEmail))
                    {
                        <div class="h-100 d-flex flex-column align-items-center justify-content-center text-muted opacity-25">
                            <i class="fas fa-comments fa-4x mb-3"></i>
                            <h5 class="fw-bold">Select a Conversation</h5>
                            <p>Choose a patient from the list to start messaging.</p>
                        </div>
                    }
                    else
                    {
                        <div class="h-100 d-flex flex-column align-items-center justify-content-center text-muted opacity-25">
                            <i class="fas fa-comment-dots fa-4x mb-3"></i>
                            <p>No messages yet. Say hello!</p>
                        </div>
                    }
                </div>

                <footer class="chat-input-area">
                    <form asp-action="SendMessage" asp-controller="Doctor" method="post" enctype="multipart/form-data" class="chat-input-form d-flex align-items-center gap-3">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="receiverEmail" value="@ViewBag.SelectedContactEmail" />
                        <label for="messageAttachment" class="btn-attach" style="cursor: pointer;">
                            <i class="fas fa-paperclip"></i>
                        </label>
                        <input type="file" name="file" id="messageAttachment" style="display: none;" onchange="updateFileNameDisplay(this)" />
                        <input type="text" name="content" id="messageContent" class="form-control message-input flex-grow-1" placeholder="Type your message here..." autocomplete="off">
                        <button type="submit" class="btn-send" @(string.IsNullOrEmpty(ViewBag.SelectedContactEmail) ? "disabled" : "")>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                    <div id="file-name-display" class="small text-muted ms-5 ps-3" style="display: none;">
                        <i class="fas fa-file me-1"></i> <span id="selected-file-name"></span>
                        <button type="button" class="btn btn-sm text-danger p-0 ms-2" onclick="clearSelectedFile()"><i class="fas fa-times"></i></button>
                    </div>
                </footer>
            </section>
        </div>
    </div>
</div>
<partial name="_VideoCallModal" />
<br>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatHistory = document.getElementById('chatHistory');
        if(chatHistory) chatHistory.scrollTop = chatHistory.scrollHeight;

        // Search Filter
        const searchInput = document.getElementById('patientSearch');
        const convItems = document.querySelectorAll('.conversation-item');

        if(searchInput) {
            searchInput.addEventListener('input', function() {
                const term = this.value.toLowerCase();
                convItems.forEach(item => {
                    const name = item.getAttribute('data-name');
                    if(name.includes(term)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        }
    });

    function updateFileNameDisplay(input) {
        const display = document.getElementById('file-name-display');
        const nameSpan = document.getElementById('selected-file-name');
        if (input.files && input.files[0]) {
            nameSpan.textContent = input.files[0].name;
            display.style.display = 'block';
            document.getElementById('messageContent').required = false;
        } else {
            display.style.display = 'none';
        }
    }

    function clearSelectedFile() {
        const input = document.getElementById('messageAttachment');
        const display = document.getElementById('file-name-display');
        input.value = '';
        display.style.display = 'none';
        document.getElementById('messageContent').required = true;
    }
</script>
