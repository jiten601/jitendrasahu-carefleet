@model IEnumerable<CareFleet.Models.MedicalRecord>
@{
    ViewData["Title"] = "Medical Records";
    Layout = "~/Views/Shared/_PatientLayout.cshtml";
    ViewBag.ActivePage = "MedicalRecords";
    ViewBag.HeaderTitle = "Medical Records";
}

<div class="medical-records-page fade-in">
    <!-- Header Card -->
    <div class="premium-header-card mb-4">
        <div class="header-card-content">
            <div class="header-info">
                <h2 class="fw-800 text-white mb-2">My Medical Records</h2>
                <p class="text-white opacity-75 mb-0">Securely manage your clinical reports and health history.</p>
            </div>
            <div class="header-actions">
                <button class="btn-premium-light" onclick="exportAllRecords()">
                    <i class="fas fa-file-pdf me-2"></i>Export All Records
                </button>
            </div>
        </div>
        <div class="header-bg-pattern"></div>
    </div>

    <!-- Main Content Card -->
    <div class="dashboard-card border-0 shadow-sm overflow-hidden">
        <div class="card-header-premium">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                <div class="d-flex align-items-center gap-2">
                    <span class="header-icon-box">
                        <i class="fas fa-file-medical-alt"></i>
                    </span>
                    <div>
                        <h5 class="mb-0 fw-bold">Health Documents</h5>
                        <small class="text-secondary">A central repository for your medical information</small>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <div class="search-box-modern">
                        <i class="fas fa-search"></i>
                        <input type="text" id="recordSearch" placeholder="Search records...">
                    </div>
                    <select class="btn-filter-modern" id="categoryFilter">
                        <option value="All Categories">All Categories</option>
                        <option value="Laboratory">Laboratory</option>
                        <option value="Radiology">Radiology</option>
                        <option value="General Health">General Health</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="activity-table-modern">
                    <thead>
                        <tr>
                            <th class="ps-4">Document Name</th>
                            <th>Category</th>
                            <th>Date Issued</th>
                            <th>Provider</th>
                            <th class="text-end pe-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTableBody">
                        @if (Model != null && Model.Any())
                        {
                            foreach (var record in Model)
                            {
                                <tr class="record-row" data-category="@record.Category" data-name="@record.DocumentName.ToLower()">
                                    <td class="ps-4">
                                        <div class="d-flex align-items-center">
                                            <div class="doc-icon-box @(record.Category == "Laboratory" ? "bg-soft-info" : record.Category == "Radiology" ? "bg-soft-warning" : "bg-soft-primary")">
                                                <i class="fas @(record.Category == "Laboratory" ? "fa-vials" : record.Category == "Radiology" ? "fa-x-ray" : "fa-file-medical")"></i>
                                            </div>
                                            <div>
                                                <div class="fw-bold text-dark">@record.DocumentName</div>
                                                <div class="x-small text-muted">@record.FileType Document â€¢ @(string.IsNullOrEmpty(record.FilePath) ? "N/A" : "Ready")</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge-modern bg-light">@record.Category</span>
                                    </td>
                                    <td>
                                        <div class="date-text">@record.DateIssued.ToString("MMM dd, yyyy")</div>
                                    </td>
                                    <td>
                                        <div class="provider-info">
                                            <div class="fw-medium">@record.Provider</div>
                                            <div class="x-small text-muted">Clinical Provider</div>
                                        </div>
                                    </td>
                                    <td class="text-end pe-4">
                                        <div class="d-flex justify-content-end gap-2">
                                            <a href="@Url.Action("ViewRecord", "Patient", new { id = record.Id })" class="btn-action-light" title="View">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="@Url.Action("DownloadRecord", "Patient", new { id = record.Id })" class="btn-action-light" title="Download">
                                                <i class="fas fa-download"></i>
                                            </a>
                                            <button class="btn-action-light" title="Share" onclick="shareRecord('@record.DocumentName')">
                                                <i class="fas fa-share-alt"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="5" class="text-center py-5">
                                    <div class="text-muted">
                                        <i class="fas fa-folder-open fa-3x mb-3 d-block"></i>
                                        <p>No medical records found.</p>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('recordSearch');
        const filterSelect = document.getElementById('categoryFilter');
        const rows = document.querySelectorAll('.record-row');
        const tableBody = document.getElementById('recordsTableBody');

        function filterRecords() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedCategory = filterSelect.value;
            let visibleCount = 0;

            rows.forEach(row => {
                const name = row.dataset.name;
                const category = row.dataset.category;
                
                const matchesSearch = name.includes(searchTerm);
                const matchesCategory = selectedCategory === 'All Categories' || category === selectedCategory;

                if (matchesSearch && matchesCategory) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
        }

        if (searchInput) searchInput.addEventListener('input', filterRecords);
        if (filterSelect) filterSelect.addEventListener('change', filterRecords);

        // Export functionality (CSV)
        window.exportAllRecords = function() {
            const csvData = [];
            const headers = ['Document Name', 'Category', 'Date Issued', 'Provider'];
            csvData.push(headers.join(','));

            rows.forEach(row => {
                if (row.style.display !== 'none') {
                    const documentName = row.querySelector('.fw-bold.text-dark').innerText;
                    const category = row.querySelector('.badge-modern').innerText;
                    const dateIssued = row.querySelector('.date-text').innerText;
                    const provider = row.querySelector('.provider-info .fw-medium').innerText;
                    
                    csvData.push(`"${documentName}","${category}","${dateIssued}","${provider}"`);
                }
            });

            if (csvData.length <= 1) {
                alert('No records available to export.');
                return;
            }

            const blob = new Blob([csvData.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'MedicalRecords_Export.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };
        
        // Share functionality
        window.shareRecord = function(name) {
            alert(`Sharing options for "${name}" will be available soon! Secure sharing is currently being implemented.`);
        };
    });
</script>

@section Styles {
    <link rel="stylesheet" href="~/css/patient-medical-records.css" asp-append-version="true" />
}
